{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Yarp": "Information"
    }
  },
  "AllowedHosts": "*",

  "Gateway": {
    "EnableRateLimiting": true,
    "EnableCircuitBreaker": true,
    "EnableCaching": true,
    "EnableLoadBalancing": true,
    "EnableAuthenticationForwarding": true,
    "DefaultTimeoutSeconds": 30,
    "MaxConcurrentRequests": 100,

    "RateLimit": {
      "PermitLimit": 100,
      "WindowSeconds": 60,
      "QueueLimit": 10
    },

    "CircuitBreaker": {
      "FailureThreshold": 0.5,
      "MinimumThroughput": 10,
      "DurationOfBreakSeconds": 30,
      "SamplingDurationSeconds": 60
    },

    "Cache": {
      "DefaultDurationSeconds": 300,
      "MaxCacheSizeMB": 100,
      "VaryByQueryString": true,
      "VaryByHeaders": true,
      "VaryByHeaderNames": [ "Accept-Language", "Authorization" ]
    }
  },

  "Observability": {
    "OtlpEndpoint": "http://localhost:4317",
    "EnableTracing": true,
    "EnableMetrics": true,
    "EnableLogging": true,
    "ServiceVersion": "1.0.0"
  },

  "ReverseProxy": {
    "Routes": {
      "drivers-route": {
        "ClusterId": "drivers-cluster",
        "Match": {
          "Path": "/api/drivers/{**catch-all}"
        },
        "Transforms": [
          {
            "PathPattern": "/api/drivers/{**catch-all}"
          }
        ],
        "Metadata": {
          "Priority": 1,
          "RequireAuth": "true",
          "Roles": "Driver,Admin"
        }
      },

      "riders-route": {
        "ClusterId": "riders-cluster",
        "Match": {
          "Path": "/api/riders/{**catch-all}"
        },
        "Transforms": [
          {
            "PathPattern": "/api/riders/{**catch-all}"
          }
        ],
        "Metadata": {
          "Priority": 1,
          "RequireAuth": "true",
          "Roles": "Rider,Admin"
        }
      },

      "trips-route": {
        "ClusterId": "trips-cluster",
        "Match": {
          "Path": "/api/trips/{**catch-all}"
        },
        "Transforms": [
          {
            "PathPattern": "/api/trips/{**catch-all}"
          }
        ],
        "Metadata": {
          "Priority": 1,
          "RequireAuth": "true"
        }
      },

      "payments-route": {
        "ClusterId": "payments-cluster",
        "Match": {
          "Path": "/api/payments/{**catch-all}"
        },
        "Transforms": [
          {
            "PathPattern": "/api/payments/{**catch-all}"
          }
        ],
        "Metadata": {
          "Priority": 1,
          "RequireAuth": "true"
        }
      },

      "notifications-route": {
        "ClusterId": "notifications-cluster",
        "Match": {
          "Path": "/api/notifications/{**catch-all}"
        },
        "Transforms": [
          {
            "PathPattern": "/api/notifications/{**catch-all}"
          }
        ],
        "Metadata": {
          "Priority": 2,
          "RequireAuth": "false"
        }
      }
    },

    "Clusters": {
      "drivers-cluster": {
        "Destinations": {
          "drivers-primary": {
            "Address": "http://localhost:5001",
            "Health": "http://localhost:5001/health"
          },
          "drivers-secondary": {
            "Address": "http://localhost:5002",
            "Health": "http://localhost:5002/health"
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:05",
            "Policy": "ConsecutiveFailures",
            "Path": "/health"
          },
          "Passive": {
            "Enabled": true,
            "Policy": "TransportFailureRate",
            "ReactivationPeriod": "00:01:00"
          }
        },
        "LoadBalancingPolicy": "PowerOfTwoChoices",
        "SessionAffinity": {
          "Enabled": false
        },
        "HttpRequest": {
          "Timeout": "00:00:30"
        }
      },

      "riders-cluster": {
        "Destinations": {
          "riders-primary": {
            "Address": "http://localhost:5011",
            "Health": "http://localhost:5011/health"
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:05",
            "Policy": "ConsecutiveFailures",
            "Path": "/health"
          }
        },
        "LoadBalancingPolicy": "RoundRobin",
        "HttpRequest": {
          "Timeout": "00:00:30"
        }
      },

      "trips-cluster": {
        "Destinations": {
          "trips-primary": {
            "Address": "http://localhost:5021",
            "Health": "http://localhost:5021/health"
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:05",
            "Policy": "ConsecutiveFailures",
            "Path": "/health"
          }
        },
        "LoadBalancingPolicy": "RoundRobin",
        "HttpRequest": {
          "Timeout": "00:00:45"
        }
      },

      "payments-cluster": {
        "Destinations": {
          "payments-primary": {
            "Address": "http://localhost:5031",
            "Health": "http://localhost:5031/health"
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:05",
            "Policy": "ConsecutiveFailures",
            "Path": "/health"
          }
        },
        "LoadBalancingPolicy": "RoundRobin",
        "HttpRequest": {
          "Timeout": "00:01:00"
        }
      },

      "notifications-cluster": {
        "Destinations": {
          "notifications-primary": {
            "Address": "http://localhost:5041",
            "Health": "http://localhost:5041/health"
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:05",
            "Policy": "ConsecutiveFailures",
            "Path": "/health"
          }
        },
        "LoadBalancingPolicy": "RoundRobin",
        "HttpRequest": {
          "Timeout": "00:00:15"
        }
      }
    }
  },

  "Serilog": {
    "Using": [ "Serilog.Sinks.Console", "Serilog.Sinks.File" ],
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "Microsoft.AspNetCore": "Warning",
        "System": "Warning",
        "Yarp": "Information"
      }
    },
    "WriteTo": [
      {
        "Name": "Console",
        "Args": {
          "outputTemplate": "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj} {Properties:j}{NewLine}{Exception}"
        }
      },
      {
        "Name": "File",
        "Args": {
          "path": "logs/gateway-.log",
          "rollingInterval": "Day",
          "retainedFileCountLimit": 30,
          "outputTemplate": "[{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz}] [{Level:u3}] [{SourceContext}] {Message:lj} {Properties:j}{NewLine}{Exception}"
        }
      }
    ],
    "Enrich": [ "FromLogContext", "WithMachineName", "WithThreadId" ]
  }
}